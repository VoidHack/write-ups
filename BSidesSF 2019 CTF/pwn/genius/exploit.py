import time

from pwn import *


magic_dict = {
    0b0000: 'A',
    0b1000: 'E',
    0b0100: 'G',
    0b0101: 'I',
    0b1100: 'K',
    0b0011: 'L',
    0b1111: 'N',
    0b1001: 'O',
    0b0001: 'P',
    0b1101: 'S',
    0b0110: 'T',
    0b1011: 'U',
    0b1110: 'V',
    0b1010: 'X',
    0b0111: 'Y',
    0b0010: 'Z'
}


def gen_input(addr, val):
    b1 = (val & 0b111) | ((val & 0b10000000) >> 4)
    b2 = ((val & 0b1110000) >> 4) | ((addr & 0b10000000) >> 4)
    b3 = ((addr & 0b1110000) >> 4)
    b4 = ((addr & 0b111000000000000) >> 12) | ((addr & 0b1000))
    b5 = ((addr & 0b100000000000) >> 8) | (addr & 0b111)
    b6 = ((addr & 0b11100000000) >> 8) | ((val & 0b1000))

    return magic_dict[b1] + \
           magic_dict[b2] + \
           magic_dict[b3] + \
           magic_dict[b4] + \
           magic_dict[b5] + \
           magic_dict[b6]


REMOTE = False

def main():
    if REMOTE:
        pc = remote('genius-0a835449.challenges.bsidessf.net', 1338)
        pc.sendlineafter('continue!\n', gen_input(0x154c, 0xab))
        pc.sendlineafter('<enter>', gen_input(0x1551, 0x8b))
    else:
        pc = process('./loader')
        pc.sendlineafter('continue!\n', gen_input(0x154c, 0xab))
        pc.sendlineafter('<enter>', gen_input(0x1551, 0x8b))

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')
    ##
    ##
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    #
    ##
     #
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ###
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    #
    ###
    pc.sendline('e')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    ##
    ##
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')
    
     #
    ##
    #
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ##
    #
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ###
    pc.sendline('q')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')
    
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    ##
    ##
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ##
    #
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ###
    pc.sendline('e')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    #
    ###
    pc.sendline('e')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')
    
      #
    ###
    pc.sendline('q')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    #
    ##
     #
    pc.sendline('d')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

      #
    ###
    pc.sendline('q')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    ####
    pc.sendline('q')
    pc.sendline('d')
    pc.sendline('d')
    # pc.sendline('s')

    for i in range(13):
        pc.recvuntil('+----------+')
        pc.recvuntil('+----------+')
    pc.sendline('d')
    pc.sendline('s')

    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ##
    #
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    ##
    ##
    pc.sendline('a')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ###
    pc.sendline('q')
    pc.sendline('q')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ###
    pc.sendline('d')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ##
    #
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    ####
    pc.sendline('q')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    #
    ###
    pc.sendline('e')
    pc.sendline('e')
    pc.sendline('a')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ###
    pc.sendline('e')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

     #
    ###
    pc.sendline('q')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('d')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    #
    ###
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    #
    ###
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

      #
    ###
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('a')
    pc.sendline('q')
    pc.sendline('a')
    pc.sendline('a')
    for i in range(8):
        pc.recvuntil('+----------+')
        pc.recvuntil('+----------+')
    pc.sendline('d')
    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')

    pc.sendline('s')
    pc.recvuntil('+----------+')
    pc.recvuntil('+----------+')
    

    pc.interactive()


if __name__ == '__main__':
    main()
